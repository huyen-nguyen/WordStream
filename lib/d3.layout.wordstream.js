// Algorithm due to Jonathan Feinberg, http://static.mrfeinberg.com/bv_ch03.pdf
// Also referenced to the implementation: by Jason Davies, https://www.jasondavies.com/wordcloud/
d3.layout.wordStream=function(){function J(a){var d=d3.keys(a[0].words),c=0,n=Number.MAX_SAFE_INTEGER,g=0,f=Number.MAX_SAFE_INTEGER;d3.map(a,function(a){d3.map(d,function(e){var d=d3.max(a.words[e],function(a){return a.frequency}),b=d3.min(a.words[e],function(a){return a.frequency});g<d&&(g=d);f>b&&(f=b);d=d3.max(a.words[e],function(a){return a.sudden});e=d3.min(a.words[e],function(a){return a.sudden});c<d&&(c=d);n>e&&(n=e)})});C=c;D=n;E=g;y.domain([n,c]).range([F,G])}function V(a){var d=K(a),c=0;
    d3.map(d,function(a){var g=0;d3.keys(d[0]).forEach(function(c){g+=a[c]});g>c&&(c=g)});u.domain([0,c]).range([0,p[1]])}function L(a){var d=K(a),c=d3.keys(a[0].words),b={},g=~~(p[0]/a.length),f=[];c.forEach(function(a){var c=[];c.push({x:0,y:u(d[0][a])});d.forEach(function(e,d){c.push({x:d*g+(g>>1),y:u(e[a])})});c.push({x:p[0],y:u(d[d.length-1][a])});f.push(c)});var h=d3.layout.stack().offset("silhouette")(f),e={};c.forEach(function(a,c){e[a]=[];for(var d=1;d<h[c].length-1;d++)e[a].push({x:h[c][d].x-
        (g>>1),y:h[c][d].y0,width:g,height:h[c][d].y})});return b={topics:c,data:a,layers:h,innerBoxes:e}}function N(a,d){var c=~~Math.sqrt(d.boxWidth*d.boxWidth+d.boxHeight*d.boxHeight),b=~~(d.boxX+(d.boxWidth*(Math.random()+.5)>>1)),g=~~(d.boxY+(d.boxHeight*(Math.random()+.5)>>1)),f=H([d.boxWidth,d.boxHeight]),h=.5>Math.random()?1:-1,e=-h,k;a.x=b;a.y=g;for(a.placed=!1;k=f(e+=h);){var l=~~k[0];k=~~k[1];if(Math.max(Math.abs(l),Math.abs(k))>=c)break;a.x=b+l;a.y=g+k;if(!(0>a.x+a.x0||0>a.y+a.y0||a.x+a.x1>p[0]||
    a.y+a.y1>p[1]||O(a,d))){P(a,d);a.placed=!0;break}}}function O(a,d){for(var c=a.height,b=a.width,g=d.width,f=0;f<c;f++)for(var h=0;h<b;h++){var e=a.sprite[f*b+h];if(0!=d.sprite[(f+a.y+a.y0)*g+h+(a.x+a.x0)]&&0!=e)return!0}return!1}function P(a,d){for(var c=a.y+a.y0,b=a.x+a.x0,g=d.width,f=a.width,h=a.height,e=0;e<h;e++)for(var k=0;k<f;k++){var l=e*f+k,m=(e+c)*g+k+b;0!=a.sprite[l]&&(d.sprite[m]=a.sprite[l])}}function Q(a,d){streamPath1=[];streamPath2=[];var c=p[0],b=p[1];c=d3.select(document.createElement("svg")).attr({width:c,
    height:b});var g=c.append("g"),f=a.topics.indexOf(d),h=d3.svg.area().interpolate(z).x(function(a){return a.x}).y0(0).y1(function(a){return a.y0});b=d3.svg.area().interpolate(z).x(function(a){return a.x}).y0(function(a){return a.y+a.y0}).y1(b);g.append("path").datum(a.layers[f]).attr({d:h,stroke:"red","stroke-width":2,fill:"red",id:"path1"});g.append("path").datum(a.layers[f]).attr({d:b,stroke:"red","stroke-width":2,fill:"red",id:"path2"});return c}function R(a,b){var c=Q(a,b),d=c.select("#path1").attr("d");
    d=new Path2D(d);c=c.select("#path2").attr("d");c=new Path2D(c);var g=document.createElement("canvas");g.width=p[0];g.height=p[1];var f=g.getContext("2d");f.fillStyle="red";f.fill(d);f.fill(c);return g}function S(a,b){var c=R(a,b),d=c.width,g=c.height,f={x:0,y:0};f.width=d;f.height=g;for(var h=[],e=0;e<d*g;e++)h[e]=0;c=c.getContext("2d").getImageData(0,0,d,g).data;for(e=0;e<d*g;e++)h[e]=c[e<<2];f.sprite=h;return f}function W(a){a.width=A;a.height=2048;a=a.getContext("2d");a.fillStyle=a.strokeStyle=
    "red";a.textAlign="center";a.textBaseline="middle";return a}function X(a){for(var d=[],c,b,g,f,h,e=a.innerBoxes,k=0;k<d3.keys(e).length;k++)for(var l=d3.keys(e)[k],m=0;m<e[l].length-1;m++)h=a.innerBoxes[l][m].width,c=e[l][m].y,b=e[l][m+1].y,g=e[l][m].y+e[l][m].height,f=e[l][m+1].y+e[l][m+1].height,c=Math.atan2(c-b,h),g=Math.atan2(g-f,h),g=(c+g)/2*Y,d.push({topic:l,timeStep:m,angle:g}),m===e[l].length-2&&d.push({topic:l,timeStep:m+1,angle:0});return d}function T(a){var b=B.includes("a")?15:0,c=0,n=
    X(a),g=a.data,f=W(document.createElement("canvas"));f.clearRect(0,0,A,2048);for(var h=0,e=0,k=0,l=0;l<g.length;l++)a.topics.forEach(function(a){var d=g[l].words[a],m=d.length,p=-1;if(B.includes("f"))for(var v in n)if(a===n[v].topic&&l===n[v].timeStep){c=n[v].angle;break}for(;++p<m;){a=d[p];f.save();a.fontSize=~~y(a.sudden);a.rotate=(~~(4*Math.random())-2)*b-c;f.font=~~(a.fontSize+1)+"px "+w;var q=~~f.measureText(a.text).width,r=a.fontSize;if(a.rotate){var t=Math.sin(a.rotate*I),x=Math.cos(a.rotate*
    I);v=q*x;var M=q*t;x*=r;q=r*t;q=~~Math.max(Math.abs(v+q),Math.abs(v-q));r=~~Math.max(Math.abs(M+x),Math.abs(M-x))}r>k&&(k=r);h+q>=A&&(h=0,e+=k,k=0);if(2048<=e+r)break;f.translate(h+(q>>1),e+(r>>1));a.rotate&&f.rotate(a.rotate*I);f.fillText(a.text,0,0);a.padding&&(f.lineWidth=2*a.padding,f.strokeText(a.text,0,0));f.restore();a.width=q;a.height=r;a.x=h;a.y=e;a.x1=q>>1;a.y1=r>>1;a.x0=-a.x1;a.y0=-a.y1;a.timeStep=l;a.streamHeight=u(a.frequency);h+=q}});for(var m=0;m<g.length;m++)a.topics.forEach(function(a){a=
    g[m].words[a];for(var b=a.length,d=-1,c;++d<b;){c=a[d];var e=f.getImageData(c.x,c.y,c.width,c.height).data;c.sprite=[];for(var h=0;h<<2<e.length;h++)c.sprite.push(e[h<<2])}});return f.getImageData(0,0,A,2048)}function K(a){var b=d3.keys(a[0].words),c=[];d3.map(a,function(a){var d={};b.forEach(function(c){var b=0;a.words[c].forEach(function(a){b+=a.frequency});d[c]=b});c.push(d)});return c}function U(a){var b=a[0]/a[1];return function(a){return[b*(a*=.1)*Math.cos(a),a*Math.sin(a)]}}var t=[],p=[1200,
    500],G=24,F=10,w="Arial",B="n",y=d3.scale.linear(),u=d3.scale.linear(),H=U,z="linear",b={},I=Math.PI/180,Y=180/Math.PI,A=0<=fileName.indexOf("Quantum")?25E3:16384,C,D,E;b.boxes=function(){J(t);V(t);var a=L(t);T(a);for(var b=0;b<a.topics.length;b++)for(var c=a.topics[b],n=S(a,c),g=a.innerBoxes[c],f=0;f<a.data.length;f++){var h=a.data[f].words[c],e=h.length,k=g[f];n.boxWidth=k.width;n.boxHeight=k.height;n.boxX=k.x;n.boxY=k.y;for(k=0;k<e;k++)N(h[k],n)}return a};var Z={achemedean:U,rectangular:function(a){return function(a){}}};
    b.getImageData=T;b.cloudCollide=O;b.place=N;b.buildSvg=Q;b.buildCanvas=R;b.buildBoard=S;b.placeWordToBoard=P;b.buildBoxes=L;b.buildFontScale=J;b.interpolate=function(a){return arguments.length?(z=a,b):z};b.streamPath1=function(a){return arguments.length?(streamPath1=a,b):streamPath1};b.streamPath2=function(a){return arguments.length?(streamPath1=a,b):streamPath2};b.font=function(a){return arguments.length?(w=a,b):w};b.frequencyScale=function(a){return arguments.length?(u=a,b):u};b.spiral=function(a){return arguments.length?
        (H=Z[a]||a,b):H};b.data=function(a){return arguments.length?(t=a,b):t};b.size=function(a){return arguments.length?(p=a,b):p};b.maxFontSize=function(a){return arguments.length?(G=a,b):G};b.minFontSize=function(a){return arguments.length?(F=a,b):F};b.minSud=function(a){return arguments.length?(D=a,b):D};b.maxSud=function(a){return arguments.length?(C=a,b):C};b.minFreq=function(a){return arguments.length?(minFreq=a,b):minFreq};b.maxFreq=function(a){return arguments.length?(E=a,b):E};b.fontScale=function(a){return arguments.length?
        (y=a,b):y};b.font=function(a){return arguments.length?(w=a,b):w};b.flag=function(a){return arguments.length?(B=a,b):B};return b};